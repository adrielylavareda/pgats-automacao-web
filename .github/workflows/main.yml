name: Web E2E Tests

on: 
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© Clona o repositÃ³rio
      - uses: actions/checkout@v4

      # ğŸ§© Exibe versÃ£o do Node
      - name: Node version
        run: node --version

      # ğŸ§© Instala dependÃªncias
      - name: Instalando dependÃªncias
        run: npm install

      # ğŸ§© Executa os testes E2E
      - name: Executando os testes
        run: npx cypress run --browser chrome --headless

      # ğŸ§© Gera o relatÃ³rio consolidado Mochawesome automaticamente
      - name: Gerar relatÃ³rio consolidado Mochawesome
        run: |
          mkdir -p cypress/reports/final
          echo "ğŸ”„ Unindo relatÃ³rios Mochawesome..."
          npm run report:full
          if [ -f cypress/reports/final/final-report.html ]; then
            echo "âœ… RelatÃ³rio consolidado gerado em cypress/reports/final/final-report.html"
          else
            echo "âš ï¸ Nenhum relatÃ³rio consolidado encontrado. Verifique os testes."
          fi

      # ğŸ§© Organiza vÃ­deos por spec 
      - name: Organizar vÃ­deos por spec
        run: |
          mkdir -p cypress/videos/organized
          for video in cypress/videos/*.mp4; do
            specName=$(basename "$video" .mp4)
            mkdir -p "cypress/videos/organized/$specName"
            mv "$video" "cypress/videos/organized/$specName/"
          done

      # ğŸ§© upload dos artefatos
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: relatorios
          path: |
            cypress/reports
            cypress/screenshots
            cypress/videos/organized
